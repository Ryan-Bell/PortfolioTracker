package WebService;

import Market.MarketEquity;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;

public class RequestYahooAPI {
    String tickers;
    DOMParser XMLParser;

    public RequestYahooAPI(ArrayList<MarketEquity> marketEquities) {
        this.tickers = packMarketEquitiesToQueryString(marketEquities);
        this.XMLParser = new DOMParser();
    }

    public ArrayList<MarketEquity> getUpdatedMarketEquities() {
        ArrayList<MarketEquity> updatedMarketEquities = new ArrayList<>();

        try {
            String xmlString = getXMLStringFromURL();
            updatedMarketEquities = this.XMLParser.parseXMLStringToMarketEquityArray(xmlString);
        } catch (Exception e)  {
            System.out.println("RequestYahooAPI " + e.getMessage());
        }

        return updatedMarketEquities;
    }

    public String getXMLStringFromURL() throws IOException {
        String url = getURLString();
//        String url = "https://query.yahooapis.com/v1/public/yql?q=select%20LastTradePriceOnly%2Csymbol%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%27AAPL%27,%27GOOG%27)&env=store://datatables.org/alltableswithkeys";

//        String url = "https://query.yahooapis.com/v1/public/yql?q=select%20LastTradePriceOnly%2Csymbol%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%27FOXA%27,%27%27,%27FOX%27,%27ATVI%27,%27ADBE%27,%27AKAM%27,%27ALXN%27,%27ALTR%27,%27AMZN%27,%27AAL%27,%27AMGN%27,%27ADI%27,%27AAPL%27,%27%27,%27AMAT%27,%27ADSK%27,%27ADP%27,%27AVGO%27,%27BIDU%27,%27BBBY%27,%27BIIB%27,%27BMRN%27,%27BRCM%27,%27CHRW%27,%27CA%27,%27CELG%27,%27CERN%27,%27CHTR%27,%27CHKP%27,%27CSCO%27,%27CTXS%27,%27CTSH%27,%27CMCSK%27,%27CMCSA%27,%27COST%27,%27DISCA%27,%27DISCK%27,%27DISH%27,%27DLTR%27,%27EBAY%27,%27EA%27,%27EXPD%27,%27ESRX%27,%27FB%27,%27FAST%27,%27FISV%27,%27GRMN%27,%27GILD%27,%27GOOGL%27,%27GOOG%27,%27HSIC%27,%27ILMN%27,%27INTC%27,%27INTU%27,%27ISRG%27,%27JD%27,%27KLAC%27,%27GMCR%27,%27KHC%27,%27LRCX%27,%27LBTYA%27,%27LBTYK%27,%27QVCA%27,%27LILA%27,%27LMCK%27,%27LMCA%27,%27LVNTA%27,%27LLTC%27,%27MAR%27,%27MAT%27,%27MU%27,%27MSFT%27,%27MDLZ%27,%27MNST%27,%27MYL%27,%27NTAP%27,%27NFLX%27,%27NVDA%27,%27NXPI%27,%27ORLY%27,%27PCAR%27,%27PAYX%27,%27QCOM%27,%27REGN%27,%27ROST%27,%27SNDK%27,%27SBAC%27,%27STX%27,%27SIRI%27,%27SWKS%27,%27SPLS%27,%27SBUX%27,%27SRCL%27,%27SYMC%27,%27TSLA%27,%27TXN%27,%27PCLN%27,%27TSCO%27,%27TRIP%27,%27VRSK%27,%27VRTX%27,%27VIAB%27,%27VIP%27,%27VOD%27,%27WBA%27,%27WDC%27,%27WFM%27,%27WYNN%27,%27XLNX%27,%27YHOO%27,%27BA%27,%27CAT%27,%27CVX%27,%27KO%27,%27DD%27,%27XOM%27,%27GE%27,%27HD%27,%27MCD%27,%27NKE%27,%27PG%27,%27UTX%27,%27VZ%27,%27V%27,%27WMT%27,%27DIS%27,%27CLGX%27,%27%27,%27GLOB%27,%27RLGY%27,%27%27,%27CBR%27,%27NNI%27,%27PFS%27,%27LUV%27,%27%27,%27ARL%27,%27WTM%27,%27HRC%27,%27%27,%27RBS^G%27,%27SFN%27,%27VLRS%27,%27MN%27,%27EVTC%27,%27LCI%27,%27EJ%27,%27STL%27,%27CSX%27,%27FCB%27,%27THG%27,%27FVE%27,%27MX%27,%27FSB%27,%27JLL%27,%27LLL%27,%27RXN%27,%27CACI%27,%27ALEX%27,%27RHT%27,%27OPK%27,%27SLH%27,%27ABT%27,%27CB%27,%27ASGN%27,%27BRS%27,%27EXH%27,%27PBH%27,%27ALR%27,%27SAP%27,%27MDT%27,%27KEY%27,%27PFG%27,%27ATE%27,%27MD%27,%27JMPC%27,%27BAC%27,%27ASC%27,%27SCHW%27,%27MSA%27,%27AMG%27,%27AHS%27,%27BSMX%27,%27CM%27,%27WF%27,%27GBL%27,%27SFUN%27,%27WAL%27,%27SHOP%27,%27MNK%27,%27PBYI%27,%27PB%27,%27HGR%27,%27IMPR%27,%27RBS^E%27,%27RLI%27,%27TRUP%27,%27UE%27,%27MXL%27,%27AVAL%27,%27XL%27,%27AFA%27,%27AGN%27,%27CUBI%27,%27SMI%27,%27GEN%20%27,%27SQNS%27,%27AEB%27,%27RKUS%27,%27CVB%27,%27AB%27,%27HNT%27,%27GSK%27,%27PFX%27,%27GJS%27,%27SSWN%27,%27MHNA%27,%27IMPV%27,%27STV%27,%27MGR%27,%27INXN%27,%27AVOL%27,%27CRL%27,%27L%27,%27WDR%27,%27ATEN%27,%27TEU%27,%27MMM%27,%27IMS%27,%27FDS%27,%27DAL%27,%27RAD%27,%27ANTX%27,%27WUBA%27,%27GHL%27,%27EXAR%27,%27AED%27,%27CUDA%27,%27BSX%27,%27RSE%27,%27C^N%27,%27BX%27,%27VMEM%27,%27RRTS%27,%27RDY%27,%27CFR%27,%27ZTS%27,%27ACE%27,%27LXFT%27,%27NM%27,%27FRO%27,%27HUBS%27,%27DGX%27,%27FIT%27,%27HCC%27,%27DSX%27,%27ENH%27,%27BHE%27,%27NMBL%27,%27JBT%27,%27KND%27,%27VR%27,%27AYR%27,%27PMC%27,%27LOCK%27,%27HSBC%27,%27MBI%27,%27URI%27,%27FCF%27,%27CPA%27,%27STJ%27,%27ABBV%27,%27DMD%27,%27CHE%27,%27BBX%27,%27DATA%27,%27AON%27,%27TMK%27,%27ALL%27,%27CPF%27,%27DFS%27,%27LXK%27,%27PRO%27,%27KCG%27,%27ALK%27,%27HSEB%27,%27BXS%27,%27TRU%27,%27IND%27,%27BEN%27,%27ABM%27,%27KFI%27,%27PYT%27,%27INZ%27,%27HPP%27,%27MSL%27,%27NQ%27,%27PAC%27,%27AVG%27,%27HCI%27,%27GSJ%27,%27LYG%27,%27EPAM%27,%27TPRE%27,%27ROL%27,%27YOKU%27,%27MSI%27,%27ALLY%27,%27DOV%27,%27BOX%27,%27AFGE%27,%27GKOS%27,%27LC%27,%27DNB%27,%27NVTA%27,%27IBM%27,%27ABC%27,%27MBLY%27,%27LNC%27,%27SLF%27,%27HLF%27,%27TWTR%27,%27CIA%27,%27BLOX%27,%27CNI%27,%27EVRI%27,%27USB^A%27,%27HLS%27,%27ORI%27,%27COF%27,%27AAN%27,%27SXI%27,%27BBT%27,%27USB%27,%27SNV%27,%27VOYA%27,%27GDDY%27,%27EIG%27,%27IX%27,%27EMC%27,%27MTB%27,%27SYK%27,%27AF%27,%27GNK%27,%27EFC%27,%27NMM%27,%27BKFS%27,%27AER%27,%27LEAF%27,%27CAI%27,%27ANTM%27,%27GMED%27,%27ONDK%27,%27WSH%27,%27BMA%27,%27GNRT%27,%27ERA%27,%27HPQ%27,%27GSL%27,%27PANW%27,%27GIMO%27,%27MKL%27,%27CRM%27,%27IHS%27,%27BAP%27,%27SYF%27,%27HRTG%27,%27OCN%27,%27NW^C%27,%27DCM%27,%27RY%27,%27IPHI%27,%27FSL%27,%27MCK%27,%27AV%27,%27SLTB%27,%27CGI%27,%27WK%27,%27FXCM%27,%27FBC%27,%27ASX%27,%27RMD%27,%27PRE%27,%27KSU^%27,%27SYA%27,%27ISG%27,%27GWR%27,%27SRG%27,%27RST%27,%27KWN%27,%27FAF%27,%27GHM%27,%27SB%27,%27AGO%27,%27BGCA%27,%27MHFI%27,%27TDOC%27,%27MWR%27,%27DTK%27,%27MOH%27,%27CKH%27,%27OPY%27,%27STC%27,%27CUBS%27,%27MIXT%27,%27ORCL%27,%27ESNT%27,%27PYS%27,%27SFL%27,%27LDOS%27,%27VRX%27,%27PUK%27,%27HCJ%27,%27PRH%27,%27VEEV%27,%27KMPR%27,%27QIHU%27,%27FAC%27,%27STE%27,%27MDLY%27,%27MET%27,%27ZPIN%27,%27AFSD%27,%27BCH%27,%27RENN%27,%27CVT%27,%27TK%27,%27LLY%27,%27JMPB%27,%27MMC%27,%27BXLT%27,%27AHH%27,%27GTY%27,%27RUBI%27,%27CBG%27,%27CTLT%27,%27BLX%27,%27SNN%27,%27AXP%27,%27STM%27,%27SBNB%27,%27PNX%27,%27WX%27,%27CYN%27,%27PKE%27,%27EW%27,%27AVV%27,%27NOK%27,%27CCG%27,%27GEB%27,%27GJT%27,%27TSM%27,%27RAX%27,%27NEWR%27,%27C^K%27,%27THC%27,%27LEJU%27,%27TNP%27,%27AEG%27,%27ASR%27,%27BMY%27,%27QTWO%27,%27N%27,%27SALT%27,%27WAC%27,%27JNS%27,%27UAM%27,%27BITA%27,%27MCRN%27,%27MTU%27,%27UHS%27,%27CNW%27,%27HSEA%27,%27HIVE%27,%27CDI%27,%27BRO%27,%27KSU%27,%27WBS%27,%27FGL%27,%27MFG%27,%27KCC%27,%27NVS%27,%27OOMA%27,%27MWW%27,%27ISF%27,%27ITG%27,%27BFR%27,%27IVC%27,%27MER^E%27,%27IMN%27,%27OFG^A%27,%27PIY%27,%27CLS%27,%27VLY%27,%27OB%27,%27ING%27,%27JBR%27,%27AMP%27,%27BCRH%27,%27APO%27,%27RM%27,%27WCG%27,%27ISH%27,%27MMI%27,%27JMP%27,%27KYO%27,%27NFJ%27,%27FDX%27,%27BNS%27,%27DHT%27,%27RBS%27,%27MTG%27,%27IL%27,%27BOCA%27,%27UNM%27,%27GSH%27,%27TNC%27,%27TZF%27,%27MRK%27,%27MCY%27,%27PAYC%27,%27BHLB%27,%27BCR%27,%27ECOM%20%27,%27FOR%27,%27CS%27,%27GOV%27,%27CAH%27,%27WD%27,%27AUO%27,%27HTH%27,%27HDB%27,%27JNPR%27,%27DKT%27,%27SF%27,%27AXS%27,%27USDP%27,%27TCB%27,%27GJV%27,%27OPWR%27,%27KTN%27,%27MER^D%27,%27CNO%27,%27IHC%27,%27CP%27,%27GTS%27,%27CIT%27,%27ZEN%27,%27CBM%27,%27WFC%27,%27RCAP%27,%27FBP%27,%27GS%27,%27MRIN%27,%27UAL%27,%27TGH%27,%27FMD%27,%27BLW%27,%27UMC%27,%27SGM%27,%27ITUB%27,%27NSAM%27,%27AFG%27,%27DB%27,%27BNK%27,%27CFG%27,%27GZT%27,%27IBN%27,%27ISP%27,%27WRB%27,%27ZBH%27,%27HMN%27,%27MODN%27,%27CMN%27,%27KING%27,%27BOH%27,%27UPS%27,%27SEM%27,%27AHL%27,%27LH%27,%27TXTR%27,%27XON%27,%27AIW%27,%27PVTD%27,%27C%27,%27CSU%27,%27DVA%27,%27PRA%27,%27OZM%27,%27TFX%27,%27BCS%27,%27BAC^W%27,%27AI%27,%27NVO%27,%27WDAY%27,%27PGR%27,%27GJO%27,%27EVER%27,%27EURN%27,%27CSC%27,%27SC%27,%27GEH%27,%27SRT%27,%27ETN%27,%27GYB%27,%27AEK%27,%27CIVI%27,%27DST%27,%27RESI%27,%27HYH%27,%27SWFT%27,%27BSAC%27,%27RGA%27,%27LUX%27,%27VLY^A%27,%27BBVA%27,%27OAK%27,%27STT%27,%27CVS%27,%27SGZA%27,%27LM%27,%27ZNH%27,%27IVZ%27,%27GDOT%27,%27BMO%27,%27RDN%27,%27ANET%27,%27SPA%27,%27SAN%27,%27SSW%27,%27THGA%27,%27GJH%27,%27CIB%27,%27JPM^H%27,%27BSBR%27,%27JBL%27,%27AIG%27,%27LFC%27,%27RJD%27,%27MWO%27,%27NPTN%27,%27KAI%27,%27OMC%27,%27NSP%27,%27FLTX%27,%27RBS^F%27,%27PJS%27,%27AFW%27,%27HAE%27,%27IM%27,%27RF%27,%27ENVA%27,%27GYC%27,%27DXB%27,%27GNW%27,%27HCA%27,%27COO%27,%27Q%27,%27WIT%27,%27AIZ%27,%27BBDO%27,%27CI%27,%27ASB%27,%27AVH%27,%27NUS%27,%27MM%27,%27LAZ%27,%27GI%27,%27TDC%27,%27BCO%27,%27MCO%27,%27CSLT%27,%27FNB%27,%27AGM%27,%27PNR%27,%27PFSI%27,%27GCAP%27,%27AWH%27,%27EVR%27,%27JGW%27,%27PRI%27,%27AZN%27,%27JNJ%27,%27UNP%27,%27RJF%27,%27PN%27,%27PZN%27,%27RE%27,%27MR%27,%27NBG%27,%27MLP%27,%27BCA%27,%27PRU%27,%27TSL%27,%27EVHC%27,%27SNX%27,%27VAC%27,%27TRV%27,%27KFH%27,%27SHG%27,%27AJG%27,%27YGE%27,%27GWRE%27,%27EMG%27,%27XKE%27,%27NMR%27,%27RBS^I%27,%27AIC%27,%27RMAX%27,%27HGH%27,%27NVGS%27,%27CMCM%27,%27VMW%27,%27AEH%27,%27CEA%27,%27MSK%27,%27CNC%27,%27HLI%27,%27COF^C%27,%27KTH%27,%27CNS%27,%27ICE%27,%27YDKN%27,%27HELI%27,%27DAC%27,%27MFC%27,%27AET%27,%27NYCB%27,%27CMRE%27,%27MHNC%27,%27TRNO%27,%27SNY%27,%27IPG%27,%27INFY%27,%27JBN%27,%27STI%27,%27ENZ%27,%27FIG%27,%27BPY%27,%27GWB%27,%27GWRU%27,%27JBK%27,%27KW%27,%27BANC%27,%27XTLY%27,%27FNF%27,%27KFY%27,%27DQ%27,%27FNFV%27,%27DPLO%27,%27DDD%27,%27JPM%27,%27ARES%27,%27TMH%27,%27GOL%27,%27TEVA%27,%27Y%27,%27KTP%27,%27INVN%27,%27AMBR%27,%27ATHM%27,%27TAL%27,%27SBNA%27,%27NOW%27,%27PNC%27,%27EFX%27,%27CMA%27,%27PFE%27,%27PJH%27,%27KMPA%27,%27HHS%27,%27RNG%27,%27SSTK%27,%27BBD%27,%27TYL%27,%27BLK%27,%27FII%27,%27EXAM%27,%27AFM%27,%27OMAM%27,%27STNG%27,%27TBI%27,%27NOAH%27,%27USPH%27,%27KFS%27,%27NVRO%27,%27BAC^Y%27,%27BKD%27,%27DFT%27,%27BKU%27,%27LPG%27,%27BK%27,%27SSNI%27,%27SAIC%27,%27RHI%27,%27DSXN%27,%27GSF%27,%27AL%27,%27NEFF%27,%27NBHC%27,%27KKR%27,%27LFL%27,%27NSM%27,%27OMI%27,%27VAR%27,%27OFG%27,%27FHN%27,%27CBU%27,%27TD%27,%27LNKD%27,%27LADR%27,%27QTM%27,%27MAN%27,%27MWG%27,%27PFK%27,%27APAM%27,%27CO%27,%27UVE%27,%27SWI%27,%27PRGO%27,%27PHH%27,%27EV%27,%27MER^F%27,%27BDX%27,%27AFSS%27,%27CW%27,%27KNX%27,%27CYH%27,%27JKS%27,%27AFL%27,%27CNA%27,%27MS%27,%27SFG%27,%27RZA%27,%27CRY%27,%27NAO%27,%27JPM^A%27,%27RLD%27,%27EBS%27,%27CCM%27,%27PFH%27,%27SUNE%27,%27NSC%27,%27ZBK%27,%27CTS%27,%27NPD%27,%27TARO%27,%27SMFG%27,%27FMS%27,%27ADPT%27,%27TRC%27,%27MC%27,%27AEL%27,%27ITW%27,%27SFE%27,%27FFG%27,%27AMTD%27,%27HJV%27,%27WBK%27,%27BAX%27,%27CVG%27,%27TFG%27,%27ELLI%27,%27ATU%27,%27TRMR%27,%27DLB%27,%27YUME%27,%27SOL%27,%27WHG%27,%27DWRE%27,%27RNR%27,%27KB%27,%27HIG%27,%27HUM%27,%27UIS%27,%27UNH%27,%27GEK%27,%27MHNB%27,%27NNA%27,%27UBS%27,%27PJC%27,%27RBS^H%27)&env=store://datatables.org/alltableswithkeys";

        // Create a URL and open a connection
        URL YahooURL = new URL(url);
        HttpURLConnection con = (HttpURLConnection) YahooURL.openConnection();

        // Set the HTTP Request type method to GET (Default: GET)
        con.setRequestMethod("GET");
        con.setConnectTimeout(10000);
        con.setReadTimeout(10000);

        // Created a BufferedReader to read the contents of the request.
        BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
        String inputLine;
        StringBuilder response = new StringBuilder();

        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
        }

        // MAKE SURE TO CLOSE YOUR CONNECTION!
        in.close();

        // response is the contents of the XML
        return response.toString();
    }

    private String getURLString() {
        String beginning = "https://query.yahooapis.com/v1/public/yql?q=select%20LastTradePriceOnly%2Csymbol%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(";
        String middle = this.tickers;
        String end = ")&env=store://datatables.org/alltableswithkeys";

        String url = (beginning + middle + end);
        return url;
    }

    private String packMarketEquitiesToQueryString(ArrayList<MarketEquity> marketEquities) {
        String querySet = "";
        for (MarketEquity marketEquity : marketEquities) {
            String ticker = marketEquity.getTickerSymbol();
            querySet += "%27" + ticker.replaceAll("\\s+","") + "%27,";
        }

        querySet = querySet.substring(0, querySet.length()-1);

        return querySet;
    }
}
